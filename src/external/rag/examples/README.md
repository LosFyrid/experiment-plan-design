# LargeRAG ç¤ºä¾‹è„šæœ¬

æœ¬ç›®å½•åŒ…å« LargeRAG çš„å®Œæ•´ä½¿ç”¨ç¤ºä¾‹ï¼Œå¸®åŠ©å¿«é€Ÿäº†è§£ç³»ç»ŸåŠŸèƒ½å’Œç»†èŠ‚ã€‚

## ğŸ“ æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | è¯´æ˜ | è¿è¡Œé¡ºåº |
|------|------|----------|
| `1_build_index.py` | æ„å»ºç´¢å¼•ç¤ºä¾‹ | â‘  é¦–æ¬¡è¿è¡Œ |
| `2_query_and_retrieve.py` | æŸ¥è¯¢å’Œæ£€ç´¢ç¤ºä¾‹ | â‘¡ ç´¢å¼•æ„å»ºå |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. **å®‰è£…ä¾èµ–**
   ```bash
   cd src/tools/largerag
   pip install -r requirements.txt
   ```

2. **é…ç½® API Key**

   åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼š
   ```
   DASHSCOPE_API_KEY=your_api_key_here
   ```

3. **å‡†å¤‡æ–‡çŒ®æ•°æ®**

   ç¡®ä¿æ–‡çŒ®æ•°æ®ä½äºï¼š`src/tools/largerag/data/literature/`

---

## ğŸ“– ç¤ºä¾‹è¯´æ˜

### ç¤ºä¾‹ 1: æ„å»ºç´¢å¼• (`1_build_index.py`)

**åŠŸèƒ½å±•ç¤ºï¼š**
- âœ“ åˆå§‹åŒ– LargeRAG
- âœ“ ä»æ–‡ä»¶å¤¹ç»“æ„åŠ è½½æ–‡çŒ®æ•°æ®
- âœ“ æ„å»ºå‘é‡ç´¢å¼•ï¼ˆEmbedding + Chromaï¼‰
- âœ“ å±•ç¤ºç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
- âœ“ å±•ç¤ºæ–‡æ¡£å¤„ç†ç»†èŠ‚ï¼ˆå…ƒæ•°æ®ã€åˆ†å—ï¼‰
- âœ“ è¯´æ˜ç¼“å­˜ç³»ç»Ÿå·¥ä½œåŸç†

**è¿è¡Œæ–¹å¼ï¼š**
```bash
cd src/tools/largerag
python examples/1_build_index.py
```

**é¢„æœŸè¾“å‡ºï¼š**
- ç´¢å¼•æ„å»ºè¿›åº¦ï¼ˆæ–‡æ¡£åŠ è½½ â†’ åˆ†å— â†’ Embedding â†’ å­˜å‚¨ï¼‰
- å¤„ç†ç»Ÿè®¡ï¼ˆæˆåŠŸç‡ã€èŠ‚ç‚¹æ•°ã€è€—æ—¶ï¼‰
- ç´¢å¼•å…ƒæ•°æ®é‡‡æ ·å±•ç¤º
- æ€§èƒ½è¯„ä¼°ï¼ˆæ˜¯å¦è¾¾æ ‡ï¼‰

**å…³é”®ä¿¡æ¯ï¼š**
- ç´¢å¼•æ„å»ºæ—¶é—´ï¼š35ç¯‡æ–‡çŒ®çº¦ 1-3 åˆ†é’Ÿï¼ˆé¦–æ¬¡ï¼‰
- ç¼“å­˜ç”Ÿæ•ˆåï¼š<10 ç§’ï¼ˆé‡å¤ç´¢å¼•ï¼‰
- ç´¢å¼•æŒä¹…åŒ–ï¼šè‡ªåŠ¨ä¿å­˜åˆ° `data/chroma_db/`

---

### ç¤ºä¾‹ 2: æŸ¥è¯¢å’Œæ£€ç´¢ (`2_query_and_retrieve.py`)

**åŠŸèƒ½å±•ç¤ºï¼š**
- âœ“ åŠ è½½å·²æœ‰ç´¢å¼•
- âœ“ `query()` - LLM ç”Ÿæˆå®Œæ•´å›ç­”
- âœ“ `get_similar_docs()` - æ£€ç´¢æ–‡æ¡£ç‰‡æ®µï¼ˆä¸ä½¿ç”¨LLMï¼‰
- âœ“ å±•ç¤ºæ£€ç´¢ç»†èŠ‚ï¼ˆåˆ†æ•°ã€å…ƒæ•°æ®ã€æ¥æºä¿¡æ¯ï¼‰
- âœ“ å¯¹æ¯”ä¸¤ç§æŸ¥è¯¢æ–¹å¼
- âœ“ è¯´æ˜ Reranker ç²¾æ’æœºåˆ¶

**è¿è¡Œæ–¹å¼ï¼š**
```bash
cd src/tools/largerag
python examples/2_query_and_retrieve.py
```

**å‰ç½®æ¡ä»¶ï¼š**
éœ€è¦å…ˆè¿è¡Œ `1_build_index.py` æ„å»ºç´¢å¼•

**é¢„æœŸè¾“å‡ºï¼š**
- ä¸¤ç§æŸ¥è¯¢æ–¹å¼çš„å¯¹æ¯”æ¼”ç¤º
- æ£€ç´¢åˆ°çš„æ–‡æ¡£è¯¦ç»†ä¿¡æ¯ï¼ˆæ–‡æœ¬ã€åˆ†æ•°ã€å…ƒæ•°æ®ï¼‰
- Reranker å·¥ä½œæµç¨‹è¯´æ˜
- æ€§èƒ½æŒ‡æ ‡å’Œä½¿ç”¨å»ºè®®

**å…³é”®ä¿¡æ¯ï¼š**
- æŸ¥è¯¢å»¶è¿Ÿï¼š~5-10 ç§’ï¼ˆä½¿ç”¨ LLMï¼‰
- æ£€ç´¢å»¶è¿Ÿï¼š~2-5 ç§’ï¼ˆä¸ä½¿ç”¨ LLMï¼‰
- Rerankerï¼šä» 20 ä¸ªå€™é€‰ä¸­ç²¾é€‰ 5 ä¸ªæœ€ç›¸å…³æ–‡æ¡£

---

## ğŸ” åŠŸèƒ½å¯¹æ¯”

### `query()` vs `get_similar_docs()`

| ç‰¹æ€§ | `query()` | `get_similar_docs()` |
|------|-----------|----------------------|
| **ä½¿ç”¨ LLM** | âœ“ æ˜¯ | âœ— å¦ |
| **è¿”å›æ ¼å¼** | è‡ªç„¶è¯­è¨€å›ç­”ï¼ˆå­—ç¬¦ä¸²ï¼‰ | æ–‡æ¡£ç‰‡æ®µåˆ—è¡¨ |
| **é€Ÿåº¦** | è¾ƒæ…¢ (~5-10ç§’) | è¾ƒå¿« (~2-5ç§’) |
| **è¿”å›æ¥æºä¿¡æ¯** | âœ— å¦* | âœ“ æ˜¯ï¼ˆdoc_hash, page_idxï¼‰ |
| **é€‚ç”¨åœºæ™¯** | æœ€ç»ˆç”¨æˆ·æŸ¥è¯¢ | Agent/å¼€å‘è€…è°ƒè¯• |

> *æ³¨ï¼š`query()` å¯ä»¥é…ç½®è¿”å›æ¥æºï¼Œä½†å½“å‰å®ç°åªè¿”å›æ–‡æœ¬

---

## ğŸ“Š æ£€ç´¢æµç¨‹è¯¦è§£

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
[1] å‘é‡å¬å› (Vector Retrieval)
    - Embedding æŸ¥è¯¢æ–‡æœ¬
    - ä½™å¼¦ç›¸ä¼¼åº¦æ£€ç´¢
    - å¬å› top_k=20 ä¸ªå€™é€‰æ–‡æ¡£
    â†“
[2] Reranker ç²¾æ’ (Reranking)
    - DashScope gte-rerank æ¨¡å‹
    - å¯¹ 20 ä¸ªå€™é€‰é‡æ–°æ‰“åˆ†
    - è¿”å› top_n=5 ä¸ªæœ€ç›¸å…³æ–‡æ¡£
    â†“
[3] LLM ç”Ÿæˆ (ä»… query() ä½¿ç”¨)
    - åŸºäºæ£€ç´¢åˆ°çš„æ–‡æ¡£
    - Qwen-Max ç”Ÿæˆå›ç­”
    â†“
è¿”å›ç»“æœ
```

---

## âš™ï¸ é…ç½®å‚æ•°

å…³é”®é…ç½®ä½äº `config/settings.yaml`ï¼š

```yaml
# æ£€ç´¢å‚æ•°
retrieval:
  similarity_top_k: 20        # å‘é‡å¬å›æ•°é‡
  rerank_top_n: 5             # Reranker è¿”å›æ•°é‡
  similarity_threshold: 0.7   # ç›¸ä¼¼åº¦é˜ˆå€¼

# Reranker é…ç½®
reranker:
  enabled: true               # æ˜¯å¦å¯ç”¨ Reranker
  model: gte-rerank           # Reranker æ¨¡å‹

# LLM é…ç½®
llm:
  model: qwen-max             # Qwen3-235B
  temperature: 0.1            # ç”Ÿæˆæ¸©åº¦
  max_tokens: 2000            # æœ€å¤§ç”Ÿæˆé•¿åº¦
```

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### é€‰æ‹©æŸ¥è¯¢æ–¹å¼

- **éœ€è¦è‡ªç„¶è¯­è¨€å›ç­”** â†’ ä½¿ç”¨ `query()`
- **éœ€è¦åŸå§‹æ–‡æ¡£ç‰‡æ®µ** â†’ ä½¿ç”¨ `get_similar_docs()`
- **éœ€è¦æ¥æºä¿¡æ¯ï¼ˆdoc_hash, page_idxï¼‰** â†’ ä½¿ç”¨ `get_similar_docs()`

### æ€§èƒ½ä¼˜åŒ–

- è°ƒæ•´ `similarity_top_k` å¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦
- è°ƒæ•´ `rerank_top_n` æ§åˆ¶è¿”å›æ–‡æ¡£æ•°é‡
- ç¦ç”¨ Reranker æ˜¾è‘—æé€Ÿï¼ˆç²¾åº¦ä¸‹é™ï¼‰

### Agent é›†æˆ

- Agent åº”è°ƒç”¨ `get_similar_docs()` è·å–æ–‡æ¡£
- Agent è‡ªå·±æ•´åˆå¤šä¸ªå·¥å…·çš„ç»“æœ
- Agent æ ¹æ® `doc_hash` å’Œ `page_idx` è¿½æº¯åŸæ–‡çŒ®

### è°ƒè¯•æŠ€å·§

- æŸ¥çœ‹ `get_similar_docs()` çš„ `score` åˆ¤æ–­æ£€ç´¢è´¨é‡
- æ£€æŸ¥ `metadata.doc_hash` ç¡®è®¤æ¥æºæ–‡çŒ®
- å¯¹æ¯”ä¸åŒæŸ¥è¯¢çš„ `score` åˆ†å¸ƒè°ƒæ•´æ£€ç´¢å‚æ•°

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: è¿è¡Œç¤ºä¾‹æŠ¥é”™ "Index not found"

**åŸå› ï¼š** æœªæ„å»ºç´¢å¼•

**è§£å†³ï¼š**
```bash
python examples/1_build_index.py  # å…ˆæ„å»ºç´¢å¼•
python examples/2_query_and_retrieve.py  # å†è¿è¡ŒæŸ¥è¯¢
```

---

### Q2: ç´¢å¼•æ„å»ºå¾ˆæ…¢

**åŸå› ï¼š** é¦–æ¬¡è¿è¡Œéœ€è¦è®¡ç®—æ‰€æœ‰æ–‡æ¡£çš„ Embedding

**è§£å†³ï¼š**
- é¦–æ¬¡è¿è¡Œæ…¢æ˜¯æ­£å¸¸çš„ï¼ˆ35ç¯‡çº¦ 1-3 åˆ†é’Ÿï¼‰
- å¯ç”¨ç¼“å­˜åï¼Œé‡å¤è¿è¡Œä¼šéå¸¸å¿«ï¼ˆ<10ç§’ï¼‰
- ç¼“å­˜ä½ç½®ï¼š`src/tools/largerag/data/cache/`

---

### Q3: æŸ¥è¯¢å»¶è¿Ÿå¤ªé«˜

**å¯èƒ½åŸå› ï¼š**
1. Reranker ç²¾æ’è€—æ—¶ï¼ˆ~2-3ç§’ï¼‰
2. LLM ç”Ÿæˆè€—æ—¶ï¼ˆ~3-5ç§’ï¼‰
3. ç½‘ç»œå»¶è¿Ÿ

**ä¼˜åŒ–å»ºè®®ï¼š**
- ç¦ç”¨ Rerankerï¼š`config/settings.yaml` ä¸­è®¾ç½® `reranker.enabled: false`
- ä½¿ç”¨æ›´å¿«çš„ LLM æ¨¡å‹ï¼ˆä½†å›ç­”è´¨é‡å¯èƒ½ä¸‹é™ï¼‰
- ä½¿ç”¨ `get_similar_docs()` è·³è¿‡ LLM ç”Ÿæˆ

---

### Q4: å¦‚ä½•æ¸…ç©ºç´¢å¼•é‡æ–°æ„å»ºï¼Ÿ

**æ–¹æ³•1ï¼šåˆ é™¤ Chroma æ•°æ®åº“**
```bash
rm -rf src/tools/largerag/data/chroma_db
```

**æ–¹æ³•2ï¼šåˆ é™¤ç¼“å­˜ï¼ˆå¯é€‰ï¼‰**
```bash
rm -rf src/tools/largerag/data/cache
```

ç„¶åé‡æ–°è¿è¡Œ `1_build_index.py`

---

## ğŸ“š æ›´å¤šèµ„æº

- **é…ç½®è¯´æ˜**: `config/settings.yaml`
- **ç¼“å­˜æœºåˆ¶**: `docs/cache_guide.md`
- **API æ–‡æ¡£**: `largerag.py` (LargeRAG ç±»æ³¨é‡Š)
- **æµ‹è¯•ç”¨ä¾‹**: `tests/test_integration.py`

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

```
src/tools/largerag/
â”œâ”€â”€ examples/                   â† ä½ åœ¨è¿™é‡Œ
â”‚   â”œâ”€â”€ 1_build_index.py
â”‚   â”œâ”€â”€ 2_query_and_retrieve.py
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.yaml           â† é…ç½®æ–‡ä»¶
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ cache_guide.md          â† ç¼“å­˜è¯´æ˜
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ literature/             â† æ–‡çŒ®æ•°æ®
â”‚   â”œâ”€â”€ chroma_db/              â† å‘é‡ç´¢å¼•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ cache/                  â† ç¼“å­˜æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â””â”€â”€ largerag.py                 â† ä¸»æ¥å£ç±»
```

---

**ç¥ä½¿ç”¨æ„‰å¿«ï¼å¦‚æœ‰é—®é¢˜è¯·å‚è€ƒä¸»é¡¹ç›®æ–‡æ¡£ `CLAUDE.md`ã€‚**

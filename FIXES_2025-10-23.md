# ACE Framework Bug Fixes - 2025-10-23

## 修复的问题

### 1. Curator生成bullet时ID为unk-00001 ✅ 已修复

**问题原因**：
- `curator.update()` 调用时没有传递 `id_prefixes` 参数
- 导致所有bullet使用默认前缀 "unk"

**修复位置**：`src/ace_framework/curator/curator.py:132-136`

**修复方案**：自动从配置加载id_prefixes映射

```python
if id_prefixes is None:
    from utils.config_loader import get_ace_config
    ace_config = get_ace_config()
    id_prefixes = ace_config.playbook.id_prefixes
```

---

### 2. LLM返回无效section导致bullet分类错误 ✅ 已修复

**问题原因**：
- LLM可能返回不在配置中的section名称（如 "waste_disposal", "reaction_conditions"）
- 没有验证机制，导致无效section被写入playbook

**修复位置**：`src/ace_framework/curator/curator.py:344-355`

**修复方案**：Section验证 + 语义映射

```python
if section not in valid_sections:
    section_mapping = {
        "waste_disposal": "safety_protocols",
        "reaction_conditions": "procedure_design",
        "cost_optimization": "procedure_design",
        "equipment": "material_selection"
    }
    section = section_mapping.get(section, "safety_protocols")
    print(f"Warning: Invalid section '{original_section}' mapped to '{section}'")
```

---

## Playbook Sections 配置

| Section | ID前缀 | 用途 |
|---------|--------|------|
| material_selection | mat | 材料选择相关知识 |
| procedure_design | proc | 实验流程设计 |
| safety_protocols | safe | 安全协议和规范 |
| quality_control | qc | 质量控制方法 |
| troubleshooting | ts | 故障排查技巧 |
| common_mistakes | err | 常见错误警示 |

---

## 验证修复

运行ACE后检查以下几点：

1. ✅ Bullet ID格式正确（如 `safe-00019`, `proc-00005`）
2. ✅ 没有 `unk-XXXXX` 格式的ID
3. ✅ 如果LLM返回无效section，会看到Warning信息
4. ✅ Playbook中只包含6个有效section的bullets

---

## 观测工具使用

```bash
# 查看ACE学习内容（需要先运行一次ACE）
python scripts/analysis/view_ace_learning.py --run-id <RUN_ID>

# 查看完整bullet内容
python scripts/analysis/view_ace_learning.py --run-id <RUN_ID> --show-content

# 查看LLM对话详情
python scripts/analysis/view_ace_learning.py --run-id <RUN_ID> --show-prompts

# 查看playbook演化统计
python scripts/analysis/analyze_playbook_evolution.py --growth-stats

# 查看所有版本
python scripts/analysis/analyze_playbook_evolution.py --list-versions
```

---

## 修改的文件

1. `src/ace_framework/curator/curator.py`
   - 添加自动加载id_prefixes逻辑 (L132-136)
   - 添加section验证和映射逻辑 (L344-355)
   - 更新步骤编号注释 (L138-197)

2. `data/playbooks/chemistry_playbook.json`
   - 清理了3个无效bullet (从21个减少到18个)

---

**修复完成时间**: 2025-10-23  
**测试状态**: 代码逻辑已验证，待实际运行测试
